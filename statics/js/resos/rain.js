function RainyDay(e,d,c,a,b,f){this.canvasid=e;this.canvas=document.getElementById(e);this.sourceid=d;this.img=document.getElementById(d);this.prepareBackground(f?f:20,c,a);this.w=this.canvas.width;this.h=this.canvas.height;this.prepareGlass(b?b:1);this.reflection=this.REFLECTION_MINIATURE;this.trail=this.TRAIL_DROPS;this.gravity=this.GRAVITY_NON_LINEAR;this.VARIABLE_GRAVITY_THRESHOLD=3;this.VARIABLE_GRAVITY_ANGLE=Math.PI/2;this.VARIABLE_FPS=25;this.VARIABLE_FILL_STYLE="#8ED6FF";this.VARIABLE_COLLISIONS=false;this.collision=this.COLLISION_SIMPLE}RainyDay.prototype.prepareReflections=function(){this.reflected=document.createElement("canvas");this.reflected.width=this.canvas.width;this.reflected.height=this.canvas.height;var a=this.reflected.getContext("2d");a.translate(this.reflected.width/2,this.reflected.height/2);a.rotate(Math.PI);a.drawImage(this.img,-this.reflected.width/2,-this.reflected.height/2,this.reflected.width,this.reflected.height)};RainyDay.prototype.prepareGlass=function(a){this.glass=document.createElement("canvas");this.glass.width=this.canvas.width;this.glass.height=this.canvas.height;this.glass.style.position="absolute";this.glass.style.top=this.canvas.offsetTop;this.glass.style.left=this.canvas.offsetLeft;this.glass.style.zIndex=this.canvas.style.zIndex+100;this.canvas.parentNode.appendChild(this.glass);this.context=this.glass.getContext("2d");this.glass.style.opacity=a};RainyDay.prototype.preset=function(b,c,a){return{"min":b,"base":c,"quan":a}};RainyDay.prototype.rain=function(b,h){if(this.reflection!=this.REFLECTION_NONE){this.prepareReflections()}if(h>0){this.presets=b;this.PRIVATE_GRAVITY_FORCE_FACTOR_Y=(this.VARIABLE_FPS*0.005)/25;this.PRIVATE_GRAVITY_FORCE_FACTOR_X=((Math.PI/2)-this.VARIABLE_GRAVITY_ANGLE)*(this.VARIABLE_FPS*0.005)/50;if(this.VARIABLE_COLLISIONS){var a=0;for(var e=0;e<b.length;e++){if(b[e].base+b[e].min>a){a=Math.floor(b[e].base+b[e].min)}}if(a>0){var d=Math.ceil(this.w/a);var g=Math.ceil(this.h/a);this.matrix=new CollisionMatrix(d,g,a)}else{this.VARIABLE_COLLISIONS=false}}setInterval((function(c){return function(){var m=Math.random();var l;for(var k=0;k<b.length;k++){if(m<b[k].quan){l=b[k];break}}if(l){c.putDrop(new Drop(c,Math.random()*c.w,Math.random()*c.h,l.min,l.base))}}})(this),h)}else{for(var e=0;e<b.length;e++){var f=b[e];for(var j=0;j<f.quan;++j){this.putDrop(new Drop(this,Math.random()*this.w,Math.random()*this.h,f.min,f.base))}}}};RainyDay.prototype.putDrop=function(a){a.draw();if(this.gravity&&a.r1>this.VARIABLE_GRAVITY_THRESHOLD){if(this.VARIABLE_COLLISIONS){this.matrix.update(a)}a.animate()}};RainyDay.prototype.getLinepoints=function(g){var c={};c.first={x:0,y:1};var k={x:1,y:1};var f=1;var b=1;var l;var j;var n,a,m;c.first.next=k;for(var h=0;h<g;h++){l=c.first;while(l.next!=null){j=l.next;n=j.x-l.x;a=0.5*(l.x+j.x);m=0.5*(l.y+j.y);m+=n*(Math.random()*2-1);var e={x:a,y:m};if(m<f){f=m}else{if(m>b){b=m}}e.next=j;l.next=e;l=j}}if(b!=f){var d=1/(b-f);l=c.first;while(l!=null){l.y=d*(l.y-f);l=l.next}}else{l=c.first;while(l!=null){l.y=1;l=l.next}}return c};function Drop(f,e,d,a,c){this.x=Math.floor(e);this.y=Math.floor(d);this.r1=(Math.random()*c)+a;this.rainyday=f;var b=4;this.r2=0.8*this.r1;this.linepoints=f.getLinepoints(b);this.context=f.context;this.reflection=f.reflected}Drop.prototype.draw=function(){var c=0;var b;var a,e;var d,f;this.context.save();this.context.beginPath();b=this.linepoints.first;e=c;a=this.r2+0.5*Math.random()*(this.r2-this.r1);d=this.x+a*Math.cos(e);f=this.y+a*Math.sin(e);this.context.lineTo(d,f);while(b.next!=null){b=b.next;e=(Math.PI*2*b.x)+c;a=this.r2+0.5*Math.random()*(this.r2-this.r1);d=this.x+a*Math.cos(e);f=this.y+a*Math.sin(e);this.context.lineTo(d,f)}this.context.clip();if(this.rainyday.reflection){this.rainyday.reflection(this)}this.context.restore()};Drop.prototype.clear=function(a){this.context.clearRect(this.x-this.r1-1,this.y-this.r1-1,2*this.r1+2,2*this.r1+2);if(a){clearInterval(this.intid);return true}if(this.y-this.r1>this.rainyday.h){clearInterval(this.intid);return true}if((this.x-this.r1>this.rainyday.w)||(this.x+this.r1<0)){clearInterval(this.intid);return true}return false};Drop.prototype.animate=function(){this.intid=setInterval((function(a){return function(){var b=a.rainyday.gravity(a);if(!b&&a.rainyday.trail){a.rainyday.trail(a)}if(a.rainyday.VARIABLE_COLLISIONS){var c=a.rainyday.matrix.update(a,b);if(c){a.rainyday.collision(a,c.drop)}}}})(this),Math.floor(1000/this.rainyday.VARIABLE_FPS))};RainyDay.prototype.TRAIL_NONE=function(a){};RainyDay.prototype.TRAIL_DROPS=function(a){if(!a.trail_y||a.y-a.trail_y>=Math.random()*10*a.r1){a.trail_y=a.y;this.putDrop(new Drop(this,a.x,a.y-a.r1-5,0,Math.ceil(a.r1/5)))}};RainyDay.prototype.GRAVITY_NONE=function(a){return true};RainyDay.prototype.GRAVITY_LINEAR=function(a){if(a.clear()){return true}if(a.yspeed){a.yspeed+=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y*Math.floor(a.r1);a.xspeed+=this.PRIVATE_GRAVITY_FORCE_FACTOR_X*Math.floor(a.r1)}else{a.yspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y;a.xspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_X}a.y+=a.yspeed;a.draw();return false};RainyDay.prototype.GRAVITY_NON_LINEAR=function(a){if(a.clear()){return true}if(!a.seed||a.seed<0){a.seed=Math.floor(Math.random()*this.VARIABLE_FPS);a.skipping=a.skipping==false?true:false;a.slowing=true}a.seed--;if(a.yspeed){if(a.slowing){a.yspeed/=1.1;a.xspeed/=1.1;if(a.yspeed<this.PRIVATE_GRAVITY_FORCE_FACTOR_Y){a.slowing=false}}else{if(a.skipping){a.yspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y;a.xspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_X}else{a.yspeed+=10*this.PRIVATE_GRAVITY_FORCE_FACTOR_Y*Math.floor(a.r1);a.xspeed+=10*this.PRIVATE_GRAVITY_FORCE_FACTOR_X*Math.floor(a.r1)}}}else{a.yspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y;a.xspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_X}a.y+=a.yspeed;a.x+=a.xspeed;a.draw();return false};RainyDay.prototype.REFLECTION_NONE=function(a){this.context.fillStyle=this.VARIABLE_FILL_STYLE;this.context.fill()};RainyDay.prototype.REFLECTION_MINIATURE=function(a){this.context.drawImage(this.reflected,a.x-a.r1,a.y-a.r1,a.r1*2,a.r1*2)};RainyDay.prototype.COLLISION_SIMPLE=function(b,a){b.clear();a.clear(true);b.x=(b.x+a.x)/2;b.y=(b.y+a.y)/2};var mul_table=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];var shg_table=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];RainyDay.prototype.prepareBackground=function(b,d,a){if(d&&a){this.canvas.style.width=d+"px";this.canvas.style.height=a+"px";this.canvas.width=d;this.canvas.height=a}else{d=this.canvas.width;a=this.canvas.height}var c=this.canvas.getContext("2d");c.clearRect(0,0,d,a);c.drawImage(this.img,0,0,d,a);if(isNaN(b)||b<1){return}this.stackBlurCanvasRGB(0,0,d,a,b)};RainyDay.prototype.stackBlurCanvasRGB=function(B,z,a,b,K){K|=0;var S=this.canvas.getContext("2d");var O=S.getImageData(B,z,a,b);var f=O.data;var I,H,Q,N,n,r,k,d,e,w,l,A,u,E,J,o,j,q,s,D;var R=K+K+1;var F=a<<2;var m=a-1;var M=b-1;var h=K+1;var L=h*(h+1)/2;var C=new BlurStack();var v=C;for(Q=1;Q<R;Q++){v=v.next=new BlurStack();if(Q==h){var g=v}}v.next=C;var P=null;var G=null;k=r=0;var t=mul_table[K];var c=shg_table[K];for(H=0;H<b;H++){E=J=o=d=e=w=0;l=h*(j=f[r]);A=h*(q=f[r+1]);u=h*(s=f[r+2]);d+=L*j;e+=L*q;w+=L*s;v=C;for(Q=0;Q<h;Q++){v.r=j;v.g=q;v.b=s;v=v.next}for(Q=1;Q<h;Q++){N=r+((m<Q?m:Q)<<2);d+=(v.r=(j=f[N]))*(D=h-Q);e+=(v.g=(q=f[N+1]))*D;w+=(v.b=(s=f[N+2]))*D;E+=j;J+=q;o+=s;v=v.next}P=C;G=g;for(I=0;I<a;I++){f[r]=(d*t)>>c;f[r+1]=(e*t)>>c;f[r+2]=(w*t)>>c;d-=l;e-=A;w-=u;l-=P.r;A-=P.g;u-=P.b;N=(k+((N=I+K+1)<m?N:m))<<2;E+=(P.r=f[N]);J+=(P.g=f[N+1]);o+=(P.b=f[N+2]);d+=E;e+=J;w+=o;P=P.next;l+=(j=G.r);A+=(q=G.g);u+=(s=G.b);E-=j;J-=q;o-=s;G=G.next;r+=4}k+=a}for(I=0;I<a;I++){J=o=E=e=w=d=0;r=I<<2;l=h*(j=f[r]);A=h*(q=f[r+1]);u=h*(s=f[r+2]);d+=L*j;e+=L*q;w+=L*s;v=C;for(Q=0;Q<h;Q++){v.r=j;v.g=q;v.b=s;v=v.next}n=a;for(Q=1;Q<=K;Q++){r=(n+I)<<2;d+=(v.r=(j=f[r]))*(D=h-Q);e+=(v.g=(q=f[r+1]))*D;w+=(v.b=(s=f[r+2]))*D;E+=j;J+=q;o+=s;v=v.next;if(Q<M){n+=a}}r=I;P=C;G=g;for(H=0;H<b;H++){N=r<<2;f[N]=(d*t)>>c;f[N+1]=(e*t)>>c;f[N+2]=(w*t)>>c;d-=l;e-=A;w-=u;l-=P.r;A-=P.g;u-=P.b;N=(I+(((N=H+h)<M?N:M)*a))<<2;d+=(E+=(P.r=f[N]));e+=(J+=(P.g=f[N+1]));w+=(o+=(P.b=f[N+2]));P=P.next;l+=(j=G.r);A+=(q=G.g);u+=(s=G.b);E-=j;J-=q;o-=s;G=G.next;r+=a}}S.putImageData(O,B,z)};function BlurStack(){this.r=0;this.g=0;this.b=0;this.a=0;this.next=null}function CollisionMatrix(a,e,d){this.resolution=d;this.xc=a;this.yc=e;this.matrix=new Array(a);for(var c=0;c<=(a+5);c++){this.matrix[c]=Array(e);for(var b=0;b<=(e+5);++b){this.matrix[c][b]=new DropItem(null)}}}CollisionMatrix.prototype.update=function(b,a){if(b.gid){this.matrix[b.gmx][b.gmy].remove(b);if(a){return null}b.gmx=Math.floor(b.x/this.resolution);b.gmy=Math.floor(b.y/this.resolution);this.matrix[b.gmx][b.gmy].add(b);var c=this.collisions(b);if(c&&c.next!=null){return c.next}}else{b.gid=Math.random().toString(36).substr(2,9);b.gmx=Math.floor(b.x/this.resolution);b.gmy=Math.floor(b.y/this.resolution);this.matrix[b.gmx][b.gmy].add(b)}return null};CollisionMatrix.prototype.collisions=function(a){var b=new DropItem(null);var c=b;b=this.addAll(b,a.gmx-1,a.gmy);b=this.addAll(b,a.gmx-1,a.gmy+1);b=this.addAll(b,a.gmx,a.gmy+1);b=this.addAll(b,a.gmx+1,a.gmy+1);b=this.addAll(b,a.gmx+1,a.gmy);return c};CollisionMatrix.prototype.addAll=function(d,a,c){if(a>0&&c>0&&a<this.xc&&c<this.yc){var b=this.matrix[a][c];while(b.next!=null){b=b.next;d.next=new DropItem(b.drop);d=d.next}}return d};function DropItem(a){this.drop=a;this.next=null}DropItem.prototype.add=function(a){var b=this;while(b.next!=null){b=b.next}b.next=new DropItem(a)};DropItem.prototype.remove=function(b){var c=this;var a=null;while(c.next!=null){a=c;c=c.next;if(c.drop.gid==b.gid){a.next=c.next}}};/*var engine = new RainyDay('rainCanvas','rainImg', window.innerWidth, window.innerHeight);engine.gravity = engine.GRAVITY_NON_LINEAR;engine.trail = engine.TRAIL_DROPS;engine.rain([engine.preset(0, 2, 500)]);engine.rain([engine.preset(3, 3, 0.88),engine.preset(5, 5, 0.9),engine.preset(6, 2, 1),], 100);*/