WaterCanvas=function(e,a,f,c,d){d=d||{};this.backgroundImageUrl=d.backgroundImageUrl||null;this.lightRefraction=d.lightRefraction||9;this.lightReflection=d.lightReflection||0.1;this.showStats=d.showStats||false;this.width=e;this.height=a;this.documentElement=document.getElementById(f);this.waterModel=c;this.canvas=document.createElement("canvas");this.canvasHelp=document.createElement("canvas");if(!this.canvas.getContext||!this.canvasHelp.getContext){alert("You need a browser that supports the HTML5 canvas tag.");return}this.ctx=this.canvas.getContext("2d");this.ctxHelp=this.canvasHelp.getContext("2d");this.setSize(e,a);this.documentElement.appendChild(this.canvas);this.fps=-1;if(this.showStats){this.fpsCounter=0;this.prevMs=0;var b=this;setInterval(function(){b.findFps()},1000)}this.drawNextFrame()};WaterCanvas.prototype.setSize=function(b,a){this.width=b;this.height=a;this.canvas.setAttribute("width",this.width);this.canvas.setAttribute("height",this.height);this.canvasHelp.setAttribute("width",this.width);this.canvasHelp.setAttribute("height",this.height);this.setBackground(this.backgroundImageUrl)};WaterCanvas.prototype.setBackground=function(d){this.backgroundImageUrl=d==""?null:d;this.pixelsIn=null;if(this.backgroundImageUrl!=null){this.backgroundImg=new Image();var b=this;this.backgroundImg.onload=function(){b.ctxHelp.drawImage(b.backgroundImg,0,0,b.width,b.height);var e=b.ctxHelp.getImageData(0,0,b.width,b.height);b.pixelsIn=e.data;b.ctx.putImageData(e,0,0)};this.backgroundImg.src=this.backgroundImageUrl}else{var a=pointerCtx.createRadialGradient(this.width/2,this.height/2,0,this.width/2,this.height/2,this.height/2);a.addColorStop(0,"#4af");a.addColorStop(1,"#000");this.ctxHelp.fillStyle=a;this.ctxHelp.fillRect(0,0,this.width,this.height);this.ctxHelp.shadowColor="white";this.ctxHelp.shadowOffsetX=0;this.ctxHelp.shadowOffsetY=0;this.ctxHelp.shadowBlur=10;this.ctxHelp.textBaseline="top";this.ctxHelp.font="normal 200 26px verdana";this.ctxHelp.fillStyle="white";this.ctxHelp.fillText("Welcome To BakerStreet",10,(this.height/2)-40);this.ctxHelp.font="normal 200 16px verdana";this.ctxHelp.fillText("Get Sherlâ˜ºck in 221B",140,(this.height/2)+8);this.ctxHelp.fillText("more fun on http://www.bakerstreet.top",10,(this.height/2)+30);var c=this.ctxHelp.getImageData(0,0,this.width,this.height);this.pixelsIn=c.data;this.ctx.putImageData(c,0,0)}};WaterCanvas.prototype.drawNextFrame=function(){if(this.pixelsIn==null||!this.waterModel.isEvolving()){var q=this;setTimeout(function(){q.drawNextFrame()},50);return}var h=this.ctx.getImageData(0,0,this.width,this.height);var e=h.data;for(var s=0;n=e.length,s<n;s+=4){var d=s/4;var l=d%this.width;var k=(d-l)/this.width;var t=this.waterModel.getWater(l,k);var b=Math.round(t*this.lightRefraction);var f=l+b;var o=k+b;if(f<0){f=0}if(o<0){o=0}if(f>this.width-1){f=this.width-1}if(o>this.height-1){o=this.height-1}var c=((o*this.width)+f)*4;var g=this.pixelsIn[c];var m=this.pixelsIn[c+1];var a=this.pixelsIn[c+2];t*=this.lightReflection;t+=1;e[s]=g*=t;e[s+1]=m*=t;e[s+2]=a*=t;e[s+3]=255}this.ctx.putImageData(h,0,0);if(this.showStats){this.fpsCounter++;this.ctx.textBaseline="top";this.ctx.font="normal 90 1px arial";var r=this.ctx.createLinearGradient(0,0,250,0);r.addColorStop(0,"#00A2FF");r.addColorStop(1,"#FF0005");this.ctx.fillStyle=r;var u="...";var p=this.getFps();var j=this.waterModel.getFps();if(p<j){if((j-p)%2==0){u="...."}else{u="......"}}else{if(this.getFps()==this.waterModel.getFps()){u="..."}else{if((p-j)%2==0){u="...."}else{u="......"}}}this.ctx.fillText("  the game is on "+u,10,20);this.ctx.shadowColor="black";this.ctx.shadowOffsetX=0;this.ctx.shadowOffsetY=0;this.ctx.shadowBlur=2}var q=this;requestAnimFrame(function(){q.drawNextFrame()},this.canvas)};WaterCanvas.prototype.findFps=function(){if(!this.showStats){return}var b=new Date().getTime();var a=b-this.prevMs;this.fps=Math.round(((this.fpsCounter*1000)/a)*10)/10;this.prevMs=b;this.fpsCounter=0};WaterCanvas.prototype.getFps=function(){return this.fps};WaterCanvas.prototype.setLightRefraction=function(a){this.lightRefraction=a};WaterCanvas.prototype.setLightReflection=function(a){this.lightReflection=a};WaterModel=function(d,a,c){c=c||{};this.resolution=c.resolution||2;this.interpolate=c.interpolate||false;this.damping=c.damping||0.985;this.clipping=c.clipping||5;this.maxFps=c.maxFps||30;this.showStats=c.showStats||false;this.evolveThreshold=c.evolveThreshold||0.05;this.width=Math.ceil(d/this.resolution);this.height=Math.ceil(a/this.resolution);this.resetSizeAndResolution(d,a,this.resolution);this.swapMap;this.setMaxFps(this.maxFps);this.evolving=false;this.fps=-1;if(this.showStats){this.fpsCounter=0;this.prevMs=0;var b=this;setInterval(function(){b.findFps()},1000)}};WaterModel.prototype.getWater=function(f,e){xTrans=f/this.resolution;yTrans=e/this.resolution;if(!this.interpolate||this.resolution==1){xF=Math.floor(xTrans);yF=Math.floor(yTrans);if(xF>this.width-1||yF>this.height-1){return 0}return this.depthMap1[xF][yF]}xF=Math.floor(xTrans);yF=Math.floor(yTrans);xC=Math.ceil(xTrans);yC=Math.ceil(yTrans);if(xC>this.width-1||yC>this.height-1){return 0}var h=this.depthMap1[xF][yF];var a=this.depthMap1[xC][yF];var d=this.depthMap1[xF][yC];var i=this.depthMap1[xC][yC];var g=xC-xTrans;var b=yC-yTrans;var c=i*(1-g)*(1-b)+d*(g)*(1-b)+a*(b)*(1-g)+h*g*b;return c};WaterModel.prototype.setInterpolation=function(a){this.interpolate=a};WaterModel.prototype.touchWater=function(a,f,e,d){this.evolving=true;a=Math.floor(a/this.resolution);f=Math.floor(f/this.resolution);if(d.length>4||d[0].length>4){a-=d.length/2;f-=d[0].length/2}if(a<0){a=0}if(f<0){f=0}if(a>this.width){a=this.width}if(f>this.height){f=this.height}for(var c=0;c<d.length;c++){for(var b=0;b<d[0].length;b++){if(a+c>=0&&f+b>=0&&a+c<=this.width-1&&f+b<=this.height-1){this.depthMap1[a+c][f+b]-=d[c][b]*e}}}};WaterModel.prototype.renderNextFrame=function(){if(!this.evolving){return}this.evolving=false;for(var a=0;a<this.width;a++){for(var c=0;c<this.height;c++){var b=(a==0?0:this.depthMap1[a-1][c])+(a==this.width-1?0:this.depthMap1[a+1][c])+(c==0?0:this.depthMap1[a][c-1])+(c==this.height-1?0:this.depthMap1[a][c+1]);b=((b/2)-this.depthMap2[a][c])*this.damping;if(b>this.clipping){b=this.clipping}if(b<-this.clipping){b=-this.clipping}if(Math.abs(b)>this.evolveThreshold){this.evolving=true}this.depthMap2[a][c]=b}}this.swapMap=this.depthMap1;this.depthMap1=this.depthMap2;this.depthMap2=this.swapMap;this.fpsCounter++};WaterModel.prototype.isEvolving=function(){return this.evolving};WaterModel.prototype.findFps=function(){if(!this.showStats){return}var b=new Date().getTime();var a=b-this.prevMs;this.fps=Math.round(((this.fpsCounter*1000)/a)*10)/10;this.prevMs=b;this.fpsCounter=0};WaterModel.prototype.getFps=function(){return this.fps};WaterModel.prototype.setMaxFps=function(b){this.maxFps=b;clearInterval(this.maxFpsInterval);var a=this;if(this.maxFps>0){this.maxFpsInterval=setInterval(function(){a.renderNextFrame()},1000/this.maxFps)}};WaterModel.prototype.setDamping=function(a){this.damping=a};WaterModel.prototype.resetSizeAndResolution=function(d,b,c){this.width=Math.ceil(d/c);this.height=Math.ceil(b/c);this.resolution=c;this.depthMap1=new Array(this.width);this.depthMap2=new Array(this.width);for(var a=0;a<this.width;a++){this.depthMap1[a]=new Array(this.height);this.depthMap2[a]=new Array(this.height);for(var e=0;e<this.height;e++){this.depthMap1[a][e]=0;this.depthMap2[a][e]=0}}};RainMaker=function(d,a,c,b){this.width=d;this.height=a;this.waterModel=c;this.raindrop2dArray=b;this.rainMinPressure=1;this.rainMaxPressure=3};RainMaker.prototype.raindrop=function(){var a=Math.floor(Math.random()*this.width);var b=Math.floor(Math.random()*this.height);this.waterModel.touchWater(a,b,this.rainMinPressure+Math.random()*this.rainMaxPressure,this.raindrop2dArray)};RainMaker.prototype.setRaindropsPerSecond=function(b){this.rps=b;clearInterval(this.rainInterval);if(this.rps>0){var a=this;this.rainInterval=setInterval(function(){a.raindrop()},1000/this.rps)}};RainMaker.prototype.setRainMinPressure=function(a){this.rainMinPressure=a};RainMaker.prototype.setRainMaxPressure=function(a){this.rainMaxPressure=a};function enableMouseInteraction(b,d){var a=false;var c=document.getElementById(d);c.addEventListener("mousedown",function(g){a=true;var f=(g.clientX-c.offsetLeft)+document.body.scrollLeft+document.documentElement.scrollLeft;var h=(g.clientY-c.offsetTop)+document.body.scrollTop+document.documentElement.scrollTop;b.touchWater(f,h,1.5,a?finger:pixel)},false);c.addEventListener("mouseup",function(f){a=false},false);c.addEventListener("mousemove",function(g){var f=(g.clientX-c.offsetLeft)+document.body.scrollLeft+document.documentElement.scrollLeft;var h=(g.clientY-c.offsetTop)+document.body.scrollTop+document.documentElement.scrollTop;b.touchWater(f,h,1.5,a?finger:pixel)},false)}function createRadialCanvas(c,a){var d=document.createElement("canvas");d.setAttribute("width",c);d.setAttribute("height",a);pointerCtx=d.getContext("2d");var b=pointerCtx.createRadialGradient(c/2,a/2,0,c/2,a/2,a/2);b.addColorStop(0,"#fff");b.addColorStop(1,"#000");pointerCtx.fillStyle=b;pointerCtx.fillRect(0,0,c,a);return d}function create2DArray(e){var c=e.width;var o=e.height;var f=new Array(c);for(var l=0;l<c;l++){f[l]=new Array(o);for(var k=0;k<o;k++){f[l][k]=0}}var m=e.getContext("2d");var b=m.getImageData(0,0,c,o);var g=b.data;for(var j=0;n=g.length,j<n;j+=4){var d=g[j];var h=d/255;var a=j/4;var l=a%c;var k=(a-l)/c;f[l][k]=h}return f}window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(b,a){window.setTimeout(b,1000/60)}})();
var pixel=create2DArray(createRadialCanvas(2,2));
var raindrop=create2DArray(createRadialCanvas(4,4));
var finger=create2DArray(createRadialCanvas(14,14));
var width=350;
var height=275;
function initWater(){
	var b=new WaterModel(width,height,{resolution:2,interpolate:false,damping:0.985,clipping:5,evolveThreshold:0.05,maxFps:30,showStats:true});
	var c=new WaterCanvas(width,height,"dvWel",b,{backgroundImageUrl:null,lightRefraction:9,lightReflection:0.1,showStats:true});
	var a=new RainMaker(width,height,b,raindrop);enableMouseInteraction(b,"dvWel")
}
initWater();